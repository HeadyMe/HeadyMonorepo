#!/bin/bash
# List Secrets (Masked)
# Shows all environment variables with sensitive values masked

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Heady Environment Variables (Masked)${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Load .env if exists
if [ -f .env ]; then
    echo -e "${GREEN}✅ Loading from .env file${NC}"
    set -a
    source .env
    set +a
else
    echo -e "${YELLOW}⚠️  No .env file found - showing environment variables only${NC}"
fi

echo ""

# Function to mask sensitive values
mask_value() {
    local var_name="$1"
    local var_value="$2"
    
    if [ -z "$var_value" ]; then
        echo -e "${RED}(not set)${NC}"
        return
    fi
    
    # Mask keys, tokens, secrets, passwords
    if [[ "$var_name" == *"KEY"* ]] || [[ "$var_name" == *"TOKEN"* ]] || \
       [[ "$var_name" == *"SECRET"* ]] || [[ "$var_name" == *"PASSWORD"* ]] || \
       [[ "$var_name" == *"URL"* && "$var_value" == *"://"* ]]; then
        # Show first 8 chars, mask the rest
        local visible="${var_value:0:8}"
        local length=${#var_value}
        local masked_length=$((length - 8))
        if [ $masked_length -gt 0 ]; then
            echo -e "${GREEN}${visible}${'*' * $masked_length} (${length} chars, masked)${NC}"
        else
            echo -e "${GREEN}******** (masked)${NC}"
        fi
    else
        # Show non-sensitive values
        echo -e "${GREEN}${var_value}${NC}"
    fi
}

# Function to display variable
show_var() {
    local var_name="$1"
    local var_value="${!var_name}"
    
    printf "%-35s " "$var_name:"
    mask_value "$var_name" "$var_value"
}

echo -e "${BLUE}=== Required Secrets ===${NC}"
echo ""
show_var "HEADY_API_KEY"
show_var "HF_TOKEN"

echo ""
echo -e "${BLUE}=== Optional Secrets ===${NC}"
echo ""
show_var "GOOGLE_API_KEY"
show_var "GH_TOKEN"
show_var "DATABASE_URL"
show_var "COPILOT_MCP_CLOUDFLARE_API_TOKEN"
show_var "COPILOT_MCP_CLOUDFLARE_ACCOUNT_ID"

echo ""
echo -e "${BLUE}=== Server Configuration ===${NC}"
echo ""
show_var "PORT"
show_var "NODE_ENV"

echo ""
echo -e "${BLUE}=== Hugging Face ===${NC}"
echo ""
show_var "HF_TEXT_MODEL"
show_var "HF_EMBED_MODEL"
show_var "HF_MAX_CONCURRENCY"

echo ""
echo -e "${BLUE}=== Python Worker ===${NC}"
echo ""
show_var "HEADY_PYTHON_BIN"
show_var "HEADY_PY_WORKER_TIMEOUT_MS"
show_var "HEADY_PY_MAX_CONCURRENCY"

echo ""
echo -e "${BLUE}=== Admin UI ===${NC}"
echo ""
show_var "HEADY_ADMIN_ROOT"
show_var "HEADY_ADMIN_ALLOWED_PATHS"
show_var "HEADY_ADMIN_MAX_BYTES"
show_var "HEADY_ADMIN_OP_LOG_LIMIT"
show_var "HEADY_ADMIN_OP_LIMIT"

echo ""
echo -e "${BLUE}=== Security ===${NC}"
echo ""
show_var "HEADY_TRUST_PROXY"
show_var "HEADY_CORS_ORIGINS"
show_var "HEADY_RATE_LIMIT_WINDOW_MS"
show_var "HEADY_RATE_LIMIT_MAX"

echo ""
echo -e "${BLUE}=== GPU Configuration ===${NC}"
echo ""
show_var "HEADY_ADMIN_ENABLE_GPU"
show_var "REMOTE_GPU_HOST"
show_var "REMOTE_GPU_PORT"
show_var "GPU_MEMORY_LIMIT"
show_var "ENABLE_GPUDIRECT"

echo ""
echo -e "${BLUE}================================================${NC}"
echo ""
echo -e "${YELLOW}ℹ️  Sensitive values are masked for security${NC}"
echo -e "${YELLOW}ℹ️  To validate configuration: ./tools/validate-env${NC}"
echo ""
