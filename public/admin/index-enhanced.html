<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heady Admin IDE - Enhanced</title>
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="/heady-design-system.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 280px; background: #111; border-right: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; }
    .sidebar-header { padding: 12px 16px; background: #1a1a2e; color: #00d4ff; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-actions { display: flex; gap: 8px; }
    .icon-btn { background: #2a2a4e; border: 1px solid #444; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; color: #00d4ff; }
    .icon-btn:hover { background: #3a3a5e; }
    .file-tree { padding: 8px 0; flex: 1; }
    .file-item { padding: 6px 16px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; position: relative; }
    .file-item:hover { background: #1f1f3a; }
    .file-item.selected { background: #2a2a4e; border-left: 3px solid #00d4ff; }
    .context-menu { position: fixed; background: #1a1a2e; border: 1px solid #444; border-radius: 4px; padding: 4px 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .context-menu-item { padding: 8px 16px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .context-menu-item:hover { background: #2a2a4e; }
    .context-menu-separator { height: 1px; background: #333; margin: 4px 0; }
    .dialog-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .dialog { background: #1a1a2e; border: 1px solid #444; border-radius: 8px; padding: 24px; min-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.8); }
    .dialog-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #00d4ff; }
    .dialog-body { margin-bottom: 20px; }
    .dialog-label { display: block; margin-bottom: 8px; font-size: 13px; color: #888; }
    .dialog-input { width: 100%; padding: 8px 12px; background: #0a0a0f; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 13px; }
    .dialog-input:focus { outline: none; border-color: #00d4ff; }
    .dialog-actions { display: flex; gap: 12px; justify-content: flex-end; }
    .dialog-btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; border: none; }
    .dialog-btn-primary { background: #00d4ff; color: #000; font-weight: 600; }
    .dialog-btn-primary:hover { background: #33ddff; }
    .dialog-btn-secondary { background: #2a2a4e; color: #fff; }
    .dialog-btn-secondary:hover { background: #3a3a5e; }
    .main { flex: 1; display: flex; flex-direction: column; }
    .tabs { display: flex; background: #111; border-bottom: 1px solid #333; overflow-x: auto; }
    .tab { padding: 8px 16px; cursor: pointer; font-size: 13px; border-right: 1px solid #333; display: flex; align-items: center; gap: 8px; white-space: nowrap; }
    .tab:hover { background: #1f1f3a; }
    .tab.active { background: #2a2a4e; border-bottom: 2px solid #00d4ff; }
    .tab-close { cursor: pointer; opacity: 0.6; }
    .tab-close:hover { opacity: 1; color: #ff4444; }
    .editor-container { flex: 1; position: relative; }
    .editor-toolbar { display: flex; gap: 8px; padding: 8px 12px; background: #111; border-bottom: 1px solid #333; }
    .toolbar-btn { padding: 6px 12px; background: #2a2a4e; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .toolbar-btn:hover { background: #3a3a5e; }
    .panel-right { width: 360px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; }
    .panel-header { padding: 12px 16px; background: #1a1a2e; font-size: 14px; font-weight: 600; color: #00d4ff; }
    .panel-body { flex: 1; overflow-y: auto; padding: 12px; font-size: 13px; }
    .logs { background: #0a0a0f; font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; white-space: pre-wrap; padding: 8px; border: 1px solid #333; border-radius: 4px; max-height: 240px; overflow-y: auto; }
    .log-line { margin: 0; }
    .log-line.error { color: #f66; }
    .log-line.success { color: #6f6; }
    .log-line.warn { color: #fc3; }
    .log-line.info { color: #6cf; }
    .status-bar { display: flex; justify-content: space-between; padding: 4px 12px; background: #111; border-top: 1px solid #333; font-size: 11px; }
    .btn { padding: 6px 12px; background: #2a2a4e; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #3a3a5e; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .settings-group { margin-bottom: 16px; }
    .settings-group label { display: block; margin-bottom: 4px; font-size: 12px; }
    .settings-group input, .settings-group select { width: 100%; padding: 6px 8px; background: #1a1a2e; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
    .toast { position: fixed; bottom: 20px; right: 20px; background: #1a1a2e; border: 1px solid #00d4ff; border-radius: 8px; padding: 12px 16px; z-index: 3000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const API_BASE = '/api/admin';
    const HEADY_API_KEY = localStorage.getItem('headyApiKey') || prompt('Enter HEADY_API_KEY:');
    if (HEADY_API_KEY) localStorage.setItem('headyApiKey', HEADY_API_KEY);

    function apiCall(path, options = {}) {
      const url = `${API_BASE}${path}`;
      const opts = {
        headers: {
          'Content-Type': 'application/json',
          'x-heady-api-key': HEADY_API_KEY,
          ...options.headers,
        },
        ...options,
      };
      return fetch(url, opts).then(r => {
        if (!r.ok) throw new Error(`API error: ${r.status}`);
        return r.json();
      });
    }

    function Toast({ message, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);
      return <div className="toast">{message}</div>;
    }

    function Dialog({ title, children, onClose }) {
      return (
        <div className="dialog-overlay" onClick={onClose}>
          <div className="dialog" onClick={e => e.stopPropagation()}>
            <div className="dialog-title">{title}</div>
            {children}
          </div>
        </div>
      );
    }

    function FileTree({ onSelect, selectedPath, onRefresh }) {
      const [roots, setRoots] = useState([]);
      const [tree, setTree] = useState({});
      const [expanded, setExpanded] = useState({});
      const [contextMenu, setContextMenu] = useState(null);
      const [showCreateDialog, setShowCreateDialog] = useState(false);
      const [showRenameDialog, setShowRenameDialog] = useState(false);
      const [dialogData, setDialogData] = useState(null);
      const [toast, setToast] = useState(null);

      useEffect(() => {
        loadRoots();
      }, []);

      useEffect(() => {
        const handleClick = () => setContextMenu(null);
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
      }, []);

      const loadRoots = useCallback(() => {
        apiCall('/roots').then(r => setRoots(r.roots));
      }, []);

      const loadDir = useCallback(async (root, path) => {
        const res = await apiCall(`/files?root=${root.id}&path=${encodeURIComponent(path)}`);
        setTree(prev => ({ ...prev, [`${root.id}:${path}`]: res.entries }));
      }, []);

      const toggle = useCallback((root, path) => {
        const key = `${root.id}:${path}`;
        setExpanded(prev => ({ ...prev, [key]: !prev[key] }));
        if (!expanded[key]) loadDir(root, path);
      }, [expanded, loadDir]);

      const handleContextMenu = useCallback((e, root, path, item) => {
        e.preventDefault();
        e.stopPropagation();
        setContextMenu({ x: e.clientX, y: e.clientY, root, path, item });
      }, []);

      const handleCreate = useCallback(async (type) => {
        const name = prompt(`Enter ${type} name:`);
        if (!name) return;
        
        const { root, path } = dialogData || contextMenu;
        const newPath = path ? `${path}/${name}` : name;
        
        try {
          await apiCall('/file/create', {
            method: 'POST',
            body: JSON.stringify({ root: root.id, path: newPath, type }),
          });
          setToast(`${type === 'file' ? 'File' : 'Directory'} created successfully`);
          loadDir(root, path || '');
          if (onRefresh) onRefresh();
        } catch (err) {
          setToast(`Error: ${err.message}`);
        }
        setContextMenu(null);
      }, [contextMenu, dialogData, loadDir, onRefresh]);

      const handleDelete = useCallback(async () => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        const { root, path } = contextMenu;
        try {
          await apiCall('/file', {
            method: 'DELETE',
            body: JSON.stringify({ root: root.id, path }),
          });
          setToast('Deleted successfully');
          const parentPath = path.split('/').slice(0, -1).join('/');
          loadDir(root, parentPath);
          if (onRefresh) onRefresh();
        } catch (err) {
          setToast(`Error: ${err.message}`);
        }
        setContextMenu(null);
      }, [contextMenu, loadDir, onRefresh]);

      const handleRename = useCallback(async () => {
        const { root, path } = contextMenu;
        const currentName = path.split('/').pop();
        const newName = prompt('Enter new name:', currentName);
        if (!newName || newName === currentName) return;
        
        const parentPath = path.split('/').slice(0, -1).join('/');
        const newPath = parentPath ? `${parentPath}/${newName}` : newName;
        
        try {
          await apiCall('/file/rename', {
            method: 'PUT',
            body: JSON.stringify({ root: root.id, path, newPath }),
          });
          setToast('Renamed successfully');
          loadDir(root, parentPath);
          if (onRefresh) onRefresh();
        } catch (err) {
          setToast(`Error: ${err.message}`);
        }
        setContextMenu(null);
      }, [contextMenu, loadDir, onRefresh]);

      const renderTree = (root, path = '', depth = 0) => {
        const key = `${root.id}:${path}`;
        const entries = tree[key] || [];
        return entries.map(item => {
          const fullPath = path ? `${path}/${item.path}` : item.path;
          const isSelected = selectedPath === fullPath;
          if (item.type === 'directory') {
            return (
              <div key={fullPath}>
                <div 
                  className="file-item" 
                  style={{ paddingLeft: 8 + depth * 16 }} 
                  onClick={() => toggle(root, fullPath)}
                  onContextMenu={(e) => handleContextMenu(e, root, fullPath, item)}
                >
                  <span>{expanded[`${root.id}:${fullPath}`] ? 'üìÇ' : 'üìÅ'}</span> {item.name}
                </div>
                {expanded[`${root.id}:${fullPath}`] && renderTree(root, fullPath, depth + 1)}
              </div>
            );
          }
          return (
            <div 
              key={fullPath} 
              className={`file-item ${isSelected ? 'selected' : ''}`} 
              style={{ paddingLeft: 8 + depth * 16 }} 
              onClick={() => onSelect(root, fullPath, item)}
              onContextMenu={(e) => handleContextMenu(e, root, fullPath, item)}
            >
              <span>üìÑ</span> {item.name}
            </div>
          );
        });
      };

      return (
        <div className="sidebar">
          <div className="sidebar-header">
            Explorer
            <div className="sidebar-actions">
              <button className="icon-btn" onClick={() => handleCreate('file')} title="New File">üìÑ+</button>
              <button className="icon-btn" onClick={() => handleCreate('directory')} title="New Folder">üìÅ+</button>
              <button className="icon-btn" onClick={loadRoots} title="Refresh">üîÑ</button>
            </div>
          </div>
          <div className="file-tree">
            {roots.map(root => (
              <div key={root.id}>
                <div 
                  className="file-item" 
                  onClick={() => toggle(root, '')}
                  onContextMenu={(e) => handleContextMenu(e, root, '', null)}
                >
                  <span>{expanded[`${root.id}:`] ? 'üìÇ' : 'üìÅ'}</span> {root.label}
                </div>
                {expanded[`${root.id}:`] && renderTree(root, '', 0)}
              </div>
            ))}
          </div>
          {contextMenu && (
            <div 
              className="context-menu" 
              style={{ left: contextMenu.x, top: contextMenu.y }}
              onClick={e => e.stopPropagation()}
            >
              <div className="context-menu-item" onClick={() => handleCreate('file')}>
                <span>üìÑ</span> New File
              </div>
              <div className="context-menu-item" onClick={() => handleCreate('directory')}>
                <span>üìÅ</span> New Folder
              </div>
              {contextMenu.item && (
                <>
                  <div className="context-menu-separator" />
                  <div className="context-menu-item" onClick={handleRename}>
                    <span>‚úèÔ∏è</span> Rename
                  </div>
                  <div className="context-menu-item" onClick={handleDelete}>
                    <span>üóëÔ∏è</span> Delete
                  </div>
                </>
              )}
            </div>
          )}
          {toast && <Toast message={toast} onClose={() => setToast(null)} />}
        </div>
      );
    }

    function Editor({ file, onSave }) {
      const editorRef = useRef();
      const [editor, setEditor] = useState(null);

      useEffect(() => {
        if (!editorRef.current) return;
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
          const monaco = window.monaco;
          const ed = monaco.editor.create(editorRef.current, {
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
          });
          setEditor(ed);
          return () => ed.dispose();
        });
      }, []);

      useEffect(() => {
        if (!editor || !file) return;
        const model = editor.getModel();
        if (model) model.dispose();
        const uri = new window.monaco.Uri.parse(`file:///${file.path}`);
        const lang = file.path.endsWith('.py') ? 'python' : 
                     file.path.endsWith('.json') ? 'json' : 
                     file.path.endsWith('.yaml') || file.path.endsWith('.yml') ? 'yaml' :
                     file.path.endsWith('.js') ? 'javascript' :
                     file.path.endsWith('.html') ? 'html' :
                     file.path.endsWith('.css') ? 'css' :
                     'plaintext';
        const newModel = window.monaco.editor.createModel(file.content, lang, uri);
        editor.setModel(newModel);
      }, [editor, file]);

      const handleSave = useCallback(() => {
        if (!editor || !file) return;
        const content = editor.getValue();
        onSave(file.root, file.path, content, file.sha);
      }, [editor, file, onSave]);

      useEffect(() => {
        const handleKey = e => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            handleSave();
          }
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, [handleSave]);

      return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
          <div className="editor-toolbar">
            <button className="toolbar-btn" onClick={handleSave}>üíæ Save (Ctrl+S)</button>
          </div>
          <div ref={editorRef} style={{ flex: 1 }} />
        </div>
      );
    }

    function Tabs({ tabs, active, onSelect, onClose }) {
      return (
        <div className="tabs">
          {tabs.map(tab => (
            <div key={tab.path} className={`tab ${active === tab.path ? 'active' : ''}`} onClick={() => onSelect(tab)}>
              {tab.name}
              <span className="tab-close" onClick={e => { e.stopPropagation(); onClose(tab); }}>‚úï</span>
            </div>
          ))}
        </div>
      );
    }

    function Logs() {
      const [logs, setLogs] = useState([]);
      const [ops, setOps] = useState([]);

      useEffect(() => {
        apiCall('/ops').then(r => setOps(r.ops));
      }, []);

      const startBuild = useCallback(async () => {
        const res = await apiCall('/build', { method: 'POST', body: JSON.stringify({}) });
        setLogs(prev => [...prev, { level: 'info', line: `Build started: ${res.op.id}` }]);
      }, []);

      const startAudit = useCallback(async () => {
        const res = await apiCall('/audit', { method: 'POST', body: JSON.stringify({}) });
        setLogs(prev => [...prev, { level: 'info', line: `Audit started: ${res.op.id}` }]);
      }, []);

      return (
        <div>
          <div className="panel-header">Operations</div>
          <div className="panel-body">
            <div style={{ marginBottom: 12, display: 'flex', gap: 8 }}>
              <button className="btn" onClick={startBuild}>Run Build</button>
              <button className="btn" onClick={startAudit}>Run Audit</button>
            </div>
            <div className="logs">
              {logs.map((log, i) => (
                <div key={i} className={`log-line ${log.level}`}>{log.line}</div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [tabs, setTabs] = useState([]);
      const [activeTab, setActiveTab] = useState(null);
      const [selectedFile, setSelectedFile] = useState(null);
      const [refreshKey, setRefreshKey] = useState(0);

      const openFile = useCallback(async (root, path, meta) => {
        const existing = tabs.find(t => t.path === path);
        if (existing) {
          setActiveTab(path);
          setSelectedFile(existing);
          return;
        }
        const res = await apiCall(`/file?root=${root.id}&path=${encodeURIComponent(path)}`);
        const tab = { root, path, name: meta.name, ...res };
        setTabs(prev => [...prev, tab]);
        setActiveTab(path);
        setSelectedFile(tab);
      }, [tabs]);

      const closeTab = useCallback(tab => {
        setTabs(prev => prev.filter(t => t.path !== tab.path));
        if (activeTab === tab.path) {
          const idx = tabs.findIndex(t => t.path === tab.path);
          const next = tabs[idx + 1] || tabs[idx - 1];
          if (next) {
            setActiveTab(next.path);
            setSelectedFile(next);
          } else {
            setActiveTab(null);
            setSelectedFile(null);
          }
        }
      }, [tabs, activeTab]);

      const saveFile = useCallback(async (root, path, content, expectedSha) => {
        await apiCall('/file', {
          method: 'POST',
          body: JSON.stringify({ root: root.id, path, content, expectedSha }),
        });
        setTabs(prev => prev.map(t => t.path === path ? { ...t, sha: 'updated', content } : t));
        if (selectedFile && selectedFile.path === path) {
          setSelectedFile(prev => ({ ...prev, sha: 'updated', content }));
        }
      }, [selectedFile]);

      return (
        <div className="app">
          <FileTree 
            onSelect={openFile} 
            selectedPath={selectedFile?.path || ''} 
            onRefresh={() => setRefreshKey(k => k + 1)}
          />
          <div className="main">
            <Tabs tabs={tabs} active={activeTab} onSelect={setSelectedFile} onClose={closeTab} />
            {selectedFile ? (
              <Editor file={selectedFile} onSave={saveFile} />
            ) : (
              <div style={{ padding: 20, color: '#888', textAlign: 'center' }}>
                <h2>Heady Admin IDE</h2>
                <p>Open a file to start editing</p>
                <p style={{ fontSize: 12, marginTop: 20 }}>
                  Right-click in the file tree for create/delete/rename operations
                </p>
              </div>
            )}
            <div className="status-bar">
              <span>{selectedFile ? `${selectedFile.path} (${selectedFile.bytes} bytes)` : 'No file'}</span>
              <span>Heady Admin IDE ‚Ä¢ Enhanced</span>
            </div>
          </div>
          <div className="panel-right">
            <Logs />
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
