<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heady Admin IDE</title>
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
  <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <style>
    :root {
      --primary: #00d4ff;
      --primary-dim: rgba(0, 212, 255, 0.1);
      --secondary: #6366f1;
      --bg-dark: #0a0e27;
      --bg-panel: #11142b;
      --bg-header: #1a1e3e;
      --text-main: #e0e0e0;
      --text-dim: #889;
      --border: #2a2e4e;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      background: var(--bg-dark); 
      color: var(--text-main); 
      overflow: hidden; 
    }
    .sacred-geometry {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        opacity: 0.05;
        z-index: 0;
    }
    .app { display: flex; height: 100vh; position: relative; z-index: 1; }
    .sidebar { 
      width: 260px; 
      background: var(--bg-panel); 
      border-right: 1px solid var(--border); 
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 16px;
      background: var(--bg-header);
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--primary);
      text-shadow: 0 0 10px var(--primary-dim);
      border-bottom: 1px solid var(--border);
    }
    .file-tree { flex: 1; overflow-y: auto; padding: 10px 0; }
    .file-item { 
      padding: 8px 16px; 
      cursor: pointer; 
      font-size: 13px; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      color: var(--text-dim);
      transition: all 0.2s;
    }
    .file-item:hover { background: var(--primary-dim); color: var(--text-main); }
    .file-item.selected { background: var(--primary-dim); color: var(--primary); border-left: 2px solid var(--primary); }
    
    .main { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); }
    .tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); overflow-x: auto; }
    .tab { 
      padding: 10px 20px; 
      cursor: pointer; 
      font-size: 13px; 
      background: var(--bg-panel);
      color: var(--text-dim);
      border-right: 1px solid var(--border);
      min-width: 120px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tab:hover { background: var(--bg-header); color: var(--text-main); }
    .tab.active { 
      background: var(--bg-dark); 
      color: var(--primary); 
      border-top: 2px solid var(--primary); 
    }
    
    .editor-container { flex: 1; position: relative; }
    
    .panel-right { width: 320px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
    .panel-header { padding: 12px 16px; background: var(--bg-header); font-size: 13px; font-weight: 600; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .panel-body { flex: 1; overflow-y: auto; padding: 16px; font-size: 13px; }
    
    .logs { 
      background: #000; 
      font-family: 'Consolas', monospace; 
      font-size: 12px; 
      padding: 12px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      height: 100%; 
      overflow-y: auto; 
      color: #aaa;
    }
    .log-line { margin-bottom: 4px; line-height: 1.4; border-bottom: 1px solid #111; padding-bottom: 2px; }
    .log-line.error { color: #ff4444; }
    .log-line.success { color: #00ff64; }
    .log-line.warn { color: #ffaa00; }
    .log-line.info { color: #00d4ff; }
    
    .status-bar { 
      display: flex; 
      justify-content: space-between; 
      padding: 6px 16px; 
      background: var(--bg-header); 
      border-top: 1px solid var(--border); 
      font-size: 11px; 
      color: var(--text-dim);
    }
    
    .btn { 
      padding: 8px 16px; 
      background: linear-gradient(135deg, var(--secondary) 0%, #4f46e5 100%); 
      color: #fff; 
      border: none; 
      border-radius: 20px; 
      cursor: pointer; 
      font-size: 12px; 
      font-weight: 600;
      transition: transform 0.2s;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
    .btn-outline:hover { border-color: var(--primary); color: var(--primary); transform: none; }
    
    .input { 
      width: 100%; 
      padding: 10px; 
      background: #000; 
      color: #fff; 
      border: 1px solid var(--border); 
      border-radius: 6px; 
      font-size: 13px; 
      margin-top: 4px;
    }
    .input:focus { outline: none; border-color: var(--primary); }
    
    .settings-group { margin-bottom: 20px; }
    .settings-group label { display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-dim); }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--secondary); }
  </style>
</head>
<body>
  <svg class="sacred-geometry" viewBox="0 0 1000 1000">
      <circle cx="500" cy="500" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="500" cy="300" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="673" cy="400" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="673" cy="600" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="500" cy="700" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="327" cy="600" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <circle cx="327" cy="400" r="200" fill="none" stroke="#00d4ff" stroke-width="1"/>
      <path d="M500 100 L900 900 L100 900 Z" fill="none" stroke="#6366f1" stroke-width="1" opacity="0.3"/>
  </svg>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const API_BASE = '/api/admin';
    const HEADY_API_KEY = localStorage.getItem('headyApiKey') || prompt('Enter HEADY_API_KEY:');
    if (HEADY_API_KEY) localStorage.setItem('headyApiKey', HEADY_API_KEY);

    function apiCall(path, options = {}) {
      const url = `${API_BASE}${path}`;
      const opts = {
        headers: {
          'Content-Type': 'application/json',
          'x-heady-api-key': HEADY_API_KEY,
          ...options.headers,
        },
        ...options,
      };
      return fetch(url, opts).then(r => {
        if (!r.ok) throw new Error(`API error: ${r.status}`);
        return r.json();
      });
    }

    function useSSE(url, onMessage) {
      const [active, setActive] = useState(false);
      useEffect(() => {
        if (!url || !active) return;
        const es = new EventSource(url);
        es.onmessage = e => {
          const data = JSON.parse(e.data);
          onMessage(data);
        };
        es.onerror = () => {
          es.close();
          setActive(false);
        };
        return () => es.close();
      }, [url, active]);
      return { setActive };
    }

    function Terminal() {
      const termRef = useRef(null);
      const wsRef = useRef(null);
      
      useEffect(() => {
        if (!termRef.current) return;

        // Initialize Xterm
        const term = new window.Terminal({
          theme: {
            background: '#11142b',
            foreground: '#e0e0e0',
            cursor: '#00d4ff',
            selectionBackground: 'rgba(0, 212, 255, 0.3)',
            black: '#000000',
            red: '#ff4444',
            green: '#00ff64',
            yellow: '#ffaa00',
            blue: '#00d4ff',
            magenta: '#6366f1',
            cyan: '#22d3ee',
            white: '#ffffff'
          },
          fontFamily: 'Consolas, monospace',
          fontSize: 12,
          cursorBlink: true,
          convertEol: true // Important for Windows
        });
        
        const fitAddon = new window.FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(termRef.current);
        fitAddon.fit();

        // Connect WS
        const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${proto}//${window.location.host}`);
        wsRef.current = ws;

        ws.onopen = () => {
          term.write('\r\n\x1b[36m‚ö° Heady Web Terminal Connected\x1b[0m\r\n');
          ws.send(JSON.stringify({ type: 'term_init' }));
        };

        ws.onmessage = (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'term_out') {
              term.write(msg.data);
            }
          } catch (e) {}
        };

        term.onData(data => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'term_input', data }));
          }
        });

        const handleResize = () => fitAddon.fit();
        window.addEventListener('resize', handleResize);

        return () => {
          window.removeEventListener('resize', handleResize);
          term.dispose();
          if (ws.readyState === WebSocket.OPEN) ws.close();
        };
      }, []);

      return <div ref={termRef} style={{ height: '100%', width: '100%', overflow: 'hidden' }} />;
    }

    function FileTree({ onSelect, selectedPath }) {
      const [roots, setRoots] = useState([]);
      const [tree, setTree] = useState({});
      const [expanded, setExpanded] = useState({});
      const [contextMenu, setContextMenu] = useState(null);
      const [showCreateDialog, setShowCreateDialog] = useState(false);
      const [showRenameDialog, setShowRenameDialog] = useState(false);
      const [dialogData, setDialogData] = useState(null);

      useEffect(() => {
        apiCall('/roots').then(r => setRoots(r.roots));
      }, []);

      useEffect(() => {
        const handleClick = () => setContextMenu(null);
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
      }, []);

      const loadDir = useCallback(async (root, path) => {
        const res = await apiCall(`/files?root=${root.id}&path=${encodeURIComponent(path)}`);
        setTree(prev => ({ ...prev, [`${root.id}:${path}`]: res.entries }));
      }, []);

      const toggle = useCallback((root, path) => {
        const key = `${root.id}:${path}`;
        setExpanded(prev => ({ ...prev, [key]: !prev[key] }));
        if (!expanded[key]) loadDir(root, path);
      }, [expanded, loadDir]);

      const renderTree = (root, path = '', depth = 0) => {
        const key = `${root.id}:${path}`;
        const entries = tree[key] || [];
        return entries.map(item => {
          const fullPath = path ? `${path}/${item.path}` : item.path;
          const isSelected = selectedPath === fullPath;
          if (item.type === 'directory') {
            return (
              <div key={fullPath}>
                <div className="file-item" style={{ paddingLeft: 8 + depth * 16 }} onClick={() => toggle(root, fullPath)}>
                  <span>{expanded[`${root.id}:${fullPath}`] ? 'üìÇ' : 'üìÅ'}</span> {item.name}
                </div>
                {expanded[`${root.id}:${fullPath}`] && renderTree(root, fullPath, depth + 1)}
              </div>
            );
          }
          return (
            <div key={fullPath} className={`file-item ${isSelected ? 'selected' : ''}`} style={{ paddingLeft: 8 + depth * 16 }} onClick={() => onSelect(root, fullPath, item)}>
              <span>üìÑ</span> {item.name}
            </div>
          );
        });
      };

      return (
        <div>
          <div className="file-tree">
            {roots.map(root => (
              <div key={root.id}>
                <div className="file-item" onClick={() => toggle(root, '')}>
                  <span>{expanded[`${root.id}:`] ? 'üìÇ' : 'üìÅ'}</span> {root.label}
                </div>
                {expanded[`${root.id}:`] && renderTree(root, '', 0)}
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Editor({ file, onSave }) {
      const editorRef = useRef();
      const [editor, setEditor] = useState(null);

      useEffect(() => {
        if (!editorRef.current) return;
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
          const monaco = window.monaco;
          const ed = monaco.editor.create(editorRef.current, {
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
          });
          setEditor(ed);
          return () => ed.dispose();
        });
      }, []);

      useEffect(() => {
        if (!editor || !file) return;
        const model = editor.getModel();
        if (model) model.dispose();
        const uri = new window.monaco.Uri.parse(`file:///${file.path}`);
        const lang = file.path.endsWith('.py') ? 'python' : file.path.endsWith('.json') ? 'json' : file.path.endsWith('.yaml') || file.path.endsWith('.yml') ? 'yaml' : 'plaintext';
        const newModel = window.monaco.editor.createModel(file.content, lang, uri);
        editor.setModel(newModel);
      }, [editor, file]);

      const handleSave = useCallback(() => {
        if (!editor || !file) return;
        const content = editor.getValue();
        onSave(file.root, file.path, content, file.sha);
      }, [editor, file]);

      useEffect(() => {
        const handleKey = e => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            handleSave();
          }
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, [handleSave]);

      return (
        <div className="editor-container">
          <div ref={editorRef} style={{ width: '100%', height: '100%' }} />
        </div>
      );
    }

    function Tabs({ tabs, active, onSelect, onClose }) {
      return (
        <div className="tabs">
          {tabs.map(tab => (
            <div key={tab.path} className={`tab ${active === tab.path ? 'active' : ''}`} onClick={() => onSelect(tab)}>
              {tab.name}
              <span style={{ marginLeft: 8, cursor: 'pointer' }} onClick={e => { e.stopPropagation(); onClose(tab); }}>‚úï</span>
            </div>
          ))}
        </div>
      );
    }

    function Logs() {
      const [logs, setLogs] = useState([]);
      const [ops, setOps] = useState([]);
      const [selectedOp, setSelectedOp] = useState(null);
      const [streamUrl, setStreamUrl] = useState(null);
      const { setActive } = useSSE(streamUrl, data => {
        if (data.event === 'log') setLogs(prev => [...prev.slice(-200), data.data]);
        if (data.event === 'status') console.log('Status:', data.data);
        if (data.event === 'end') console.log('Stream ended');
      });

      useEffect(() => {
        apiCall('/ops').then(r => setOps(r.ops));
      }, []);

      const startBuild = useCallback(async () => {
        const res = await apiCall('/build', { method: 'POST', body: JSON.stringify({}) });
        setSelectedOp(res.op);
        setStreamUrl(res.streamUrl);
        setActive(true);
      }, []);

      const sdiv className="sidebar-header">HEADY IDE</div>
            <tartAudit = useCallback(async () => {
        const res = await apiCall('/audit', { method: 'POST', body: JSON.stringify({}) });
        setSelectedOp(res.op);
        setStreamUrl(res.streamUrl);
        setActive(true);(
                4var(--text-dim),textAlign: 'center', marginTop: 100 
                    <div style={{ fontSize: 40, marginBottom: 20, oacity: 0.2 }}>‚àû</div>
                    <h3>Selct begin</h3>
                   <p>Heady Sc Geomery Envroment Activep>
                </
            )
      }, []);
‚Ä¢ Rady
      return (Manager v14 ‚Ä¢ {winow.locato.hostname}
        <div>
          <div className="panel-header">Operations</div>
          <div className="panel-body">
            <div style={{ marginBottom: 12 }}>
              <button className="btn" onClick={startBuild}>Run Build</button>
              <button className="btn" onClicackgrkund: 'va=(--bg-hea{st)', taddingA 8,ugat:=8rginLeft: 8 }}>Run Audit</button>
            </div>e={`btn ${activePanl == 'logs' ? '' : 'tn-oulie'}`}6
            {selectedOp && (e={`btn ${activePanl == 'settings' ? '' : 'tn-oulie'}`}6
              <div style={{ marginBottom: 12 }}>
                <strong>Operation:</strong> {selectedOp.type} ({selectedOp.status})
              </div>
            )}
            <div className="logs">
              {logs.map((log, i) => (
                <div key={i} className={`log-line ${log.level}`}>{log.line}</div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function Settings() {
      const [gpuHost, setGpuHost] = useState('');
      const [gpuPort, setGpuPort] = useState('');
      const [gpuMemLimit, setGpuMemLimit] = useState('');
      const [gpuEnabled, setGpuEnabled] = useState(false);

      const save = useCallback(() => {
        localStorage.setItem('gpuHost', gpuHost);
        localStorage.setItem('gpuPort', gpuPort);
        localStorage.setItem('gpuMemLimit', gpuMemLimit);
        localStorage.setItem('gpuEnabled', gpuEnabled);
        alert('Settings saved (local only for now)');
      }, [gpuHost, gpuPort, gpuMemLimit, gpuEnabled]);

      useEffect(() => {
        setGpuHost(localStorage.getItem('gpuHost') || '');
        setGpuPort(localStorage.getItem('gpuPort') || '');
        setGpuMemLimit(localStorage.getItem('gpuMemLimit') || '');
        setGpuEnabled(localStorage.getItem('gpuEnabled') === 'true');
      }, []);

      return (
        <div>
          <div className="panel-header">Settings</div>
          <div className="panel-body">
            <div className="settings-group">
              <label>Remote GPU Host</label>
              <input className="input" value={gpuHost} onChange={e => setGpuHost(e.target.value)} placeholder="e.g. gpu.example.com" />
            </div>
            <div className="settings-group">
              <label>Remote GPU Port</label>
              <input className="input" value={gpuPort} onChange={e => setGpuPort(e.target.value)} placeholder="e.g. 4000" />
            </div>
            <div className="settings-group">
              <label>GPU Memory Limit (MB)</label>
              <input className="input" value={gpuMemLimit} onChange={e => setGpuMemLimit(e.target.value)} placeholder="e.g. 8192" />
            </div>
            <div className="settings-group">
              <label>
                <input type="checkbox" checked={gpuEnabled} onChange={e => setGpuEnabled(e.target.checked)} /> Enable Remote GPU (GPUDirect RDMA)
              </label>
            </div>
            <button className="btn" onClick={save}>Save Settings</button>
          </div>
        </div>
      );
    }

    function App() {
      const [tabs, setTabs] = useState([]);
      const [activeTab, setActiveTab] = useState(null);
      const [selectedFile, setSelectedFile] = useState(null);
      const [activePanel, setActivePanel] = useState('logs');

      const openFile = useCallback(async (root, path, meta) => {
        const existing = tabs.find(t => t.path === path);
        if (existing) {
          setActiveTab(path);
          setSelectedFile(existing);
          return;
        }
        const res = await apiCall(`/file?root=${root.id}&path=${encodeURIComponent(path)}`);
        const tab = { root, path, name: meta.name, ...res };
        setTabs(prev => [...prev, tab]);
        setActiveTab(path);
        setSelectedFile(tab);
      }, [tabs]);

      const closeTab = useCallback(tab => {
        setTabs(prev => prev.filter(t => t.path !== tab.path));
        if (activeTab === tab.path) {
          const idx = tabs.findIndex(t => t.path === tab.path);
          const next = tabs[idx + 1] || tabs[idx - 1];
          if (next) {
            setActiveTab(next.path);
            setSelectedFile(next);
          } else {
            setActiveTab(null);
            setSelectedFile(null);
          }
        }
      }, [tabs, activeTab]);

      const saveFile = useCallback(async (root, path, content, expectedSha) => {
        await apiCall('/file', {
          method: 'POST',
          body: JSON.stringify({ root: root.id, path, content, expectedSha }),
        });
        // Update tab sha
        setTabs(prev => prev.map(t => t.path === path ? { ...t, sha: 'updated', content } : t));
        if (selectedFile && selectedFile.path === path) {
          setSelectedFile(prev => ({ ...prev, sha: 'updated', content }));
        }
      }, [selectedFile]);

      return (
        <div className="app">
          <div className="sidebar">
            <FileTree onSelect={openFile} selectedPath={selectedFile?.path || ''} />
          </div>
          <div className="main">
            <Tabs tabs={tabs} active={activeTab} onSelect={setSelectedFile} onClose={closeTab} />
            {selectedFile ? <Editor file={selectedFile} onSave={saveFile} /> : <div style={{ padding: 20, color: '#888' }}>Open a file to start editing</div>}
            <div className="status-bar">
              <span>{selectedFile ? `${selectedFile.path} (${selectedFile.bytes} bytes)` : 'No file'}</span>
              <span>Heady Admin IDE</span>
            </div>
          </div>
          <div className="panel-right">
            {activePanel === 'logs' && <Logs />}
            {activePanel === 'settings' && <Settings />}
            <div style={{ display: 'flex', borderTop: '1px solid #333' }}>
              <button className="btn" style={{ flex: 1, borderRadius: 0 }} onClick={() => setActivePanel('logs')}>Logs</button>
              <button className="btn" style={{ flex: 1, borderRadius: 0 }} onClick={() => setActivePanel('settings')}>Settings</button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
