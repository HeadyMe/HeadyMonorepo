#!/bin/bash
# Environment Configuration Validator
# Validates that all required environment variables are set

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Heady Environment Configuration Validator${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Load .env if exists
if [ -f .env ]; then
    echo -e "${GREEN}✅ .env file found${NC}"
    set -a
    source .env
    set +a
else
    echo -e "${YELLOW}⚠️  .env file not found - using environment variables only${NC}"
fi

echo ""

# Counters
REQUIRED_MISSING=0
OPTIONAL_MISSING=0
TOTAL_REQUIRED=0
TOTAL_OPTIONAL=0

# Function to check required variable
check_required() {
    local var_name="$1"
    local var_value="${!var_name}"
    TOTAL_REQUIRED=$((TOTAL_REQUIRED + 1))
    
    if [ -z "$var_value" ]; then
        echo -e "${RED}❌ REQUIRED: $var_name is NOT set${NC}"
        REQUIRED_MISSING=$((REQUIRED_MISSING + 1))
        return 1
    else
        # Mask sensitive values
        if [[ "$var_name" == *"KEY"* ]] || [[ "$var_name" == *"TOKEN"* ]] || [[ "$var_name" == *"SECRET"* ]]; then
            echo -e "${GREEN}✅ $var_name is set (${var_value:0:8}...masked)${NC}"
        else
            echo -e "${GREEN}✅ $var_name is set ($var_value)${NC}"
        fi
        return 0
    fi
}

# Function to check optional variable
check_optional() {
    local var_name="$1"
    local default_value="$2"
    local var_value="${!var_name}"
    TOTAL_OPTIONAL=$((TOTAL_OPTIONAL + 1))
    
    if [ -z "$var_value" ]; then
        if [ -n "$default_value" ]; then
            echo -e "${YELLOW}ℹ️  $var_name not set (using default: $default_value)${NC}"
        else
            echo -e "${YELLOW}ℹ️  $var_name not set (optional)${NC}"
        fi
        OPTIONAL_MISSING=$((OPTIONAL_MISSING + 1))
        return 0
    else
        # Mask sensitive values
        if [[ "$var_name" == *"KEY"* ]] || [[ "$var_name" == *"TOKEN"* ]] || [[ "$var_name" == *"SECRET"* ]]; then
            echo -e "${GREEN}✅ $var_name is set (${var_value:0:8}...masked)${NC}"
        else
            echo -e "${GREEN}✅ $var_name is set ($var_value)${NC}"
        fi
        return 0
    fi
}

echo -e "${BLUE}=== Required Variables ===${NC}"
echo ""
check_required "HEADY_API_KEY"
check_required "HF_TOKEN"

echo ""
echo -e "${BLUE}=== Core Configuration ===${NC}"
echo ""
check_optional "PORT" "3300"
check_optional "NODE_ENV" "development"

echo ""
echo -e "${BLUE}=== Hugging Face Configuration ===${NC}"
echo ""
check_optional "HF_TEXT_MODEL" "gpt2"
check_optional "HF_EMBED_MODEL" "sentence-transformers/all-MiniLM-L6-v2"
check_optional "HF_MAX_CONCURRENCY" "4"

echo ""
echo -e "${BLUE}=== Python Worker Configuration ===${NC}"
echo ""
check_optional "HEADY_PYTHON_BIN" "python"
check_optional "HEADY_PY_WORKER_TIMEOUT_MS" "90000"
check_optional "HEADY_PY_MAX_CONCURRENCY" "2"

echo ""
echo -e "${BLUE}=== Admin UI Configuration ===${NC}"
echo ""
check_optional "HEADY_ADMIN_ROOT" "(repository root)"
check_optional "HEADY_ADMIN_ALLOWED_PATHS" "(none)"
check_optional "HEADY_ADMIN_MAX_BYTES" "512000"
check_optional "HEADY_ADMIN_OP_LOG_LIMIT" "2000"
check_optional "HEADY_ADMIN_OP_LIMIT" "50"

echo ""
echo -e "${BLUE}=== Security Configuration ===${NC}"
echo ""
check_optional "HEADY_TRUST_PROXY" "false"
check_optional "HEADY_CORS_ORIGINS" "(same-origin only)"
check_optional "HEADY_RATE_LIMIT_WINDOW_MS" "60000"
check_optional "HEADY_RATE_LIMIT_MAX" "120"

echo ""
echo -e "${BLUE}=== GPU Configuration (Optional) ===${NC}"
echo ""
check_optional "HEADY_ADMIN_ENABLE_GPU" "false"
check_optional "REMOTE_GPU_HOST" "(none)"
check_optional "REMOTE_GPU_PORT" "(none)"
check_optional "GPU_MEMORY_LIMIT" "(none)"
check_optional "ENABLE_GPUDIRECT" "false"

echo ""
echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Validation Summary${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""
echo "Required Variables: $TOTAL_REQUIRED"
echo -e "${GREEN}  Set: $((TOTAL_REQUIRED - REQUIRED_MISSING))${NC}"
if [ $REQUIRED_MISSING -gt 0 ]; then
    echo -e "${RED}  Missing: $REQUIRED_MISSING${NC}"
else
    echo -e "${GREEN}  Missing: 0${NC}"
fi
echo ""
echo "Optional Variables: $TOTAL_OPTIONAL"
echo -e "${GREEN}  Set: $((TOTAL_OPTIONAL - OPTIONAL_MISSING))${NC}"
echo -e "${YELLOW}  Using Defaults: $OPTIONAL_MISSING${NC}"
echo ""

# Validation result
if [ $REQUIRED_MISSING -gt 0 ]; then
    echo -e "${RED}❌ VALIDATION FAILED${NC}"
    echo -e "${RED}   Missing $REQUIRED_MISSING required variable(s)${NC}"
    echo ""
    echo "To fix:"
    echo "1. Copy .env.example to .env"
    echo "2. Edit .env and set all required variables"
    echo "3. Run this script again"
    echo ""
    exit 1
else
    echo -e "${GREEN}✅ VALIDATION PASSED${NC}"
    echo -e "${GREEN}   All required variables are set!${NC}"
    echo ""
    if [ $OPTIONAL_MISSING -gt 0 ]; then
        echo -e "${YELLOW}ℹ️  $OPTIONAL_MISSING optional variable(s) using defaults${NC}"
        echo "   This is normal for development"
    fi
    echo ""
    echo "You can now start the server with:"
    echo "  npm start"
    echo "  or"
    echo "  ./tools/admin-dev"
    echo ""
    exit 0
fi
