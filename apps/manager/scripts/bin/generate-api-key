#!/bin/bash
# API Key Generator
# Generates cryptographically secure API keys for Heady system

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Heady API Key Generator${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""

# Generate 32-byte (256-bit) random key
echo "Generating cryptographically secure API key..."
echo ""

# Method 1: OpenSSL (most secure)
if command -v openssl > /dev/null; then
    API_KEY=$(openssl rand -base64 32)
    METHOD="OpenSSL (256-bit)"
# Method 2: /dev/urandom
elif [ -r /dev/urandom ]; then
    API_KEY=$(head -c 32 /dev/urandom | base64)
    METHOD="/dev/urandom (256-bit)"
# Method 3: Node.js crypto
elif command -v node > /dev/null; then
    API_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('base64'))")
    METHOD="Node.js crypto (256-bit)"
else
    echo -e "${YELLOW}⚠️  No secure random generator available${NC}"
    echo "Please install: openssl, or ensure /dev/urandom is available"
    exit 1
fi

echo -e "${GREEN}✅ Generated using: $METHOD${NC}"
echo ""
echo -e "${BLUE}================================================${NC}"
echo -e "${BLUE}  Your New API Key${NC}"
echo -e "${BLUE}================================================${NC}"
echo ""
echo "$API_KEY"
echo ""
echo -e "${BLUE}================================================${NC}"
echo ""

# Try to copy to clipboard
if command -v pbcopy > /dev/null; then
    echo "$API_KEY" | pbcopy
    echo -e "${GREEN}✅ Copied to clipboard (macOS)${NC}"
    echo ""
elif command -v xclip > /dev/null; then
    echo "$API_KEY" | xclip -selection clipboard
    echo -e "${GREEN}✅ Copied to clipboard (Linux)${NC}"
    echo ""
elif command -v clip.exe > /dev/null; then
    echo "$API_KEY" | clip.exe
    echo -e "${GREEN}✅ Copied to clipboard (Windows WSL)${NC}"
    echo ""
else
    echo -e "${YELLOW}ℹ️  Copy the key above manually${NC}"
    echo ""
fi

# Usage instructions
echo -e "${BLUE}Usage Instructions:${NC}"
echo ""
echo "1. For local development:"
echo "   Edit .env file and set:"
echo "   HEADY_API_KEY=$API_KEY"
echo ""
echo "2. For staging/production (Render.com):"
echo "   a. Go to Render Dashboard"
echo "   b. Select your service"
echo "   c. Navigate to Environment tab"
echo "   d. Add/Update environment variable:"
echo "      Key: HEADY_API_KEY"
echo "      Value: $API_KEY"
echo ""
echo "3. Test the new key:"
echo "   curl -H \"x-heady-api-key: $API_KEY\" \\"
echo "     http://localhost:3300/api/admin/roots"
echo ""
echo -e "${YELLOW}⚠️  Security Reminders:${NC}"
echo "• Never commit this key to version control"
echo "• Use different keys for dev/staging/production"
echo "• Rotate keys quarterly (every 3 months)"
echo "• If exposed, generate new key immediately"
echo ""
echo -e "${GREEN}✅ Key generation complete!${NC}"
